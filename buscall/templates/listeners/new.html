{% extends 'standard.html' %}
{% block title %}New Listener | {{super()}}{% endblock %}
{% from "_formhelpers.html" import with_errors %}
{% block local_css %}
    <link href="/static/standard.css" rel="stylesheet" type="text/css" />
    <link href="/static/new-listener.css" rel="stylesheet" type="text/css" />
{% endblock %}
{% block main %}
<form method="POST" action="{{ url_for('new_listener') }}">
    {{form.hidden_tag()}}
    <fieldset id="bus-info">
        <legend>Bus</legend>
        {{ with_errors(form.agency_id) }}
        {{ with_errors(form.route_id) }}
        {{ with_errors(form.direction_id) }}
        {{ with_errors(form.stop_id) }}
    </fieldset>
    <fieldset id="time-info">
        <legend>Time</legend>

        {{ with_errors(form.recur) }}

        <div class="form_field dates">
            {% if form.recur.data %}
                <label id="dates-label-plural">Dates</label>
                {{ form.dow.label(id="dates-label-singular", style="display:none;") }}
            {% else %}
                <label id="dates-label-plural" style="display:none;">Dates</label>
                {{ form.dow.label(id="dates-label-singular") }}
            {% endif %}
            {% if form.errors.week or form.dow.errors %}
                <ul class="errors">
                    {% for error in form.errors.week %}
                    <li>{{ error }}</li>
                    {% endfor %}
                    {% for error in form.dow.errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            <table id="week_checkboxes" {% if not form.recur.data %}style="display:none;"{% endif %}>
                <thead>
                    {% for day in DAYS_OF_WEEK %}
                    <th>{{form[day].label}}</th>
                    {% endfor %}
                </thead>
                <tbody>
                    <tr>
                    {% for day in DAYS_OF_WEEK %}
                        <td>{{form[day]}}</td>
                    {% endfor %}
                    </tr>
                </tbody>
            </table>

            {% if form.recur.data %}
                {{ form.dow(style="display:none;") }}
            {% else %}
                {{ form.dow }}
            {% endif %}
        </div>

        <div class="form_field start">
            {{ with_errors(form.start, placeholder="7:00 AM", wrapper=False) }}
            <img src="/static/help.png" class="help_icon" />
            <p class="help_text" style="display:none;">
                This is the time that we will start checking your bus for you. For example, 
                if you expect your bus to come at 7:00 AM and you want to be alerted 5 minutes 
                before it arrives, you should set this not later than 6:55 AM, and 6:50 AM 
                is probably a better idea (in case your bus is early). In general, set this 
                5 or 10 minutes before the first alert you want to get for your bus.
            </p>
        </div>

    </fieldset>
    <fieldset id="alerts">
        <legend>{{form.alerts.label}}</legend>
        <input type="hidden" name="{{form.alerts.id}}-length" id="{{form.alerts.id}}-length" value="{{form.alerts.entries|length}}" />
        <ul id="alerts-list">
        {% for alert in form.alerts.entries %}
            <li id="{{alert.id}}">
                {% if alert.medium.errors or alert.minutes.errors %}
                <ul class="errors">
                    {% for error in alert.medium.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                    {% for error in alert.minutes.errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                {% if alert.medium.errors %}
                    {% set medium_class = "alerts-medium has_error" %}
                {% else %}
                    {% set medium_class = "alerts-medium" %}
                {% endif %}
                {% if alert.minutes.errors %}
                    {% set minutes_class = "alerts-minutes has_error" %}
                {% else %}
                    {% set minutes_class = "alerts-minutes" %}
                {% endif %}
                <p>{{alert.medium(class=medium_class)}} me {{alert.minutes(class=minutes_class)}} minutes before the bus arrives</p>
                <div class="alerts-controls">
                    <input type="button" value="+" class="add-alert">
                    <input type="button" value="-" class="delete-alert" {% if form.alerts.entries|length == 1 %}disabled="disabled"{% endif %}/>
                </div>
            </li>
        {% endfor %}
        </ul>
    </fieldset>
    <input type="submit" value="Create Listener" />
</form>
{% endblock %}
